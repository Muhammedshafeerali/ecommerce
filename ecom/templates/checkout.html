{% extends 'base.html' %}
{% block content %}
{% load static %}
<link href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<link rel="stylesheet" href="{% static 'user/checkout.css' %}">
<!------ Include the above in your HEAD tag ---------->

<div class="container wrapper">
            <div class="row cart-head">
                <div class="container">
                <div class="row">
                    <p></p>
                </div>
                
                <div class="row">
                    <p></p>
                </div>
                </div>
            </div>    
            <div class="row cart-body">
                <div class="box-element hidden" id="itme-check">
                    <h2>NO ITEMS</h2>
                </div>
                <form id="form" class="form-horizontal" method="post" action="">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 col-md-push-6 col-sm-push-6">
                    <!--REVIEW ORDER-->
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            Review Order <div class="pull-right"><small><a class="afix-1" href="#">Edit Cart</a></small></div>
                        </div>
                        <div class="panel-body">
							{% for item in items %}
                            <div class="form-group">
                                <div class="col-sm-3 col-xs-3">
                                    <img class="img-responsive" src="{{item.product.imageURL}}" />
                                </div>
                                <div class="col-sm-6 col-xs-6">
                                    <div class="col-xs-12">{{item.product.name}}</div>
                                    <div class="col-xs-12"><small>Quantity:<span>{{item.quantity}}</span></small></div>
                                </div>
                                <div class="col-sm-3 col-xs-3 text-right">
                                    <h6><span>$</span>{{item.get_total}}</h6>
                                </div>
                            </div>
                            <div class="form-group"><hr /></div>
							{% endfor %}
                            <div class="form-group"><hr /></div>
                            <div class="form-group">
                                <div class="col-xs-12">
                                    <strong>Items</strong>
                                    <div class="pull-right"><span><strong>{{order.get_cart_items}}</strong></span><span></span></div>
                                </div>
                                
                            </div>
                            <div class="form-group"><hr /></div>
                            <div class="form-group">
                                <div class="col-xs-12">
                                    <strong>Order Total</strong>
                                    <div class="pull-right"><span>$</span><span><strong> {{order.get_cart_total}}</strong></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--REVIEW ORDER END-->
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 col-md-pull-6 col-sm-pull-6">
                    <!--SHIPPING METHOD-->
                    <div class="panel panel-info" id="shipping-info">
                        <div class="panel-heading">Address</div>
                        <div class="panel-body">
                            <div class="form-group">
                                <div class="col-md-12">
                                    <h4>Shipping Address</h4>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12"><strong>Country:</strong></div>
                                <div class="col-md-12">
                                    <select class="form-control" name="" required>
                                        <option value="">Country</option>
                                        {% for country in cont %}
                                        <option value="">{{country}}</option>
                                        {%endfor%}
                                        
                                </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-6 col-xs-12">
                                    <strong>First Name:</strong>
                                    <input type="text" name="name" class="form-control" value="" required/>
                                </div>
                                <div class="span1"></div>
                                <div class="col-md-6 col-xs-12">
                                    <strong>Last Name:</strong>
                                    <input type="text" name="last_name" class="form-control" value="" required/>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12"><strong>Address:</strong></div>
                                <div class="col-md-12">
                                    <input type="text" name="address" class="form-control" value="" required/>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12"><strong>City:</strong></div>
                                <div class="col-md-12">
                                    <input type="text" name="city" class="form-control" value="" required/>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12"><strong>State:</strong></div>
                                <div class="col-md-12">
                                    <input type="text" name="state" class="form-control" value="" required/>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12"><strong>Zip / Postal Code:</strong></div>
                                <div class="col-md-12">
                                    <input type="text" name="zipcode" class="form-control"  value="" required/>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12"><strong>Phone Number:</strong></div>
                                <div class="col-md-12"><input type="tel" name="phone_number" class="form-control" value="" pattern="[6-9]{1}[0-9]{9}" required/></div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-12"><strong>Email Address:</strong></div>
                                <div class="col-md-12"><input type="email" name="email" class="form-control" value="" required/></div>
                            </div>
                        </div>
                       
                    </div>
                   
								
                        <input id="form-button" class="btn btn-success btn-block" type="submit" style="background-color: #fe980f;" value="Continue">
                        <div class="box-element hidden" id="payment-info">
                            <small>Paypal Options</small>
                            <div id="paypal-button-container"></div>
                            <button id="rzp-button1" class="btn btn-success btn-block" style="background-color: #fe980f;">RazorPay</button>
                            <!-- <button class="btn btn-warning update" id="makepayment" style="background-color: #fe980f;">Make Payment</button> -->
                            
                        </div>
                        
                    
                </div>
                
                
                </form>
                
            </div>
            <div class="row cart-footer">
        
            </div>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        var total ='{{order.get_cart_total}}'
        var payment_status='razorpay'
        var options = {
            "key": "rzp_test_7i01eG7knm1628", // Enter the Key ID generated from the Dashboard
            "amount": total, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "USD",
            "name": "Acme Corp",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": "{{order_id}}", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response){
               
                submitFormData(payment_status)
            },
            "prefill": {
                "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                "contact": "9999999999"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#F37254"
            }
        };
        var rzp1 = new Razorpay(options);
        document.getElementById('rzp-button1').onclick = function(e){
            rzp1.open();
            e.preventDefault();
        }
        </script>
    <script src="https://www.paypal.com/sdk/js?client-id=AYtodiSdVNbDP1Kn-G9ScgW79r5dczXhaDzz5gT8a1Jm-TB4tn9a5soO5rcNP7Q104W5s8iJoE7Es7ot&currency=USD&disable-funding=card"></script>
    <script>
        var total ='{{order.get_cart_total}}'
        var payment='paypal'
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            

            // Set up the transaction
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: parseFloat(total).toFixed(2)
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    submitFormData(payment)
                });
            }


        }).render('#paypal-button-container');
    </script>

    <script type="text/javascript">
        var item = '{{order.get_cart_items}}'
        var shipping='{{order.shipping}}'
        // var total ='{{order.get_cart_total}}'
        if (item == 0){
            document.getElementById('form').innerHTML=""
            document.getElementById('itme-check').classList.remove('hidden')

        }
        
        var form = document.getElementById('form')
        form.addEventListener('submit',function(e){
            e.preventDefault()
            console.log('form submitted')
            document.getElementById('form-button').classList.add('hidden')
            document.getElementById('payment-info').classList.remove('hidden')
           
        })
        

        function submitFormData(payment_status){
            console.log('payment clicked',total)

            var userFormData = {
                'name':null,
                'email':null,
                'total':total,
            }
            var shippingInfo = {
                'address':null,
                'city':null,
                'state':null,
                'zipcode':null,
                'payment_status':null
            }
            if(shipping!='False'){
                shippingInfo.address=form.address.value
                shippingInfo.city=form.city.value
                shippingInfo.state=form.state.value
                shippingInfo.zipcode=form.zipcode.value
                shippingInfo.payment_status=payment_status

            }
            if(user=='AnonymousUser'){
                userFormData.name=form.name.value
                userFormData.email=form.email.value
                
            }

            var url='/cart/proces/'
            fetch(url,{
                method:'POST',
                headers:{
                    'Content-Type':'application/json',
                    'X-CSRFToken':csrftoken,
                },
                body:JSON.stringify({'form':userFormData,'shipping':shippingInfo})

            })
            .then((response) => response.json())
            
            .then((data) => {
                alert('Transaction completed');
                console.log('succes:',data);
                cart={}
                console.log("cart was created")
                document.cookie ='cart=' + JSON.stringify(cart) + ";domain=;path=/"
                window.location.href="/"
            })
        }


    </script>


    
{% endblock %}